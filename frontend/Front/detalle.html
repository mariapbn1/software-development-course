<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Detalle del Producto | Inventario</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

  </head>
  <body class="detalle-page">
<nav class="navbar navbar-dark bg-dark shadow-sm mb-4">
  <div class="container justify-content-center">
    <a class="navbar-brand fw-bold" href="#">
      MOBILE PHONE
    </a>
  </div>
</nav>


    <div class="container mt-5">





      <div class="row g-4">

  <nav aria-label="breadcrumb" class="mb-3">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="productos.html">Inicio</a></li>
    <li class="breadcrumb-item active" id="breadcrumbProduct" aria-current="page">Cargando...</li>
  </ol>
</nav>
  <!-- PRODUCT DETAIL CARD -->
  <div class="col-12">
    <div class="card border-0 shadow-sm p-4 h-100">
      <div class="text-center mb-4">
        <img
          id="pImg"
          src="https://via.placeholder.com/400x300?text=Cargando..."
          class="img-fluid product-img shadow-sm"
          alt="Producto"
        />
      </div>
      <h1 id="pName" class="fw-bold">Cargando producto...</h1>
      <div class="d-flex gap-2 mb-3">
        <span id="pRam" class="badge bg-primary badge-tech">-- GB RAM</span>
        <span id="pStorage" class="badge bg-info text-dark badge-tech">-- GB</span>
        <span id="pBattery" class="badge bg-success badge-tech">-- mAh</span>
      </div>
      <p id="pSynopsis" class="text-muted fs-5 lh-base">
        Obteniendo descripción desde el servidor...
      </p>
      <hr />
      <div class="row text-center small fw-bold">
        <div class="col-4">
          Cámara Principal<br /><span id="pCam" class="text-dark">-- MP</span>
        </div>
        <div class="col-4">
          NFC<br /><span id="pNfc" class="text-dark">--</span>
        </div>
        <div class="col-4">
          Fecha Lanzamiento<br /><span id="pDate" class="text-dark">--</span>
        </div>
      </div>
    </div>
  </div>

  <!-- COMMENTS CARD -->
  <div class="col-12 mt-4">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-header bg-white fw-bold py-3">
        COMENTARIOS DE USUARIOS
      </div>
      <div class="card-body d-flex flex-column">
        <div id="commentsList" class="comment-scroll flex-grow-1 mb-4">
          <p class="text-center text-muted small py-5">
            Cargando comentarios...
          </p>
        </div>

        <form id="commentForm" class="bg-light p-3 rounded shadow-sm">
          <div class="mb-2">
            <input
              type="text"
              id="cUser"
              class="form-control form-control-sm"
              placeholder="Tu nombre"
              required
            />
          </div>
          <div class="mb-2">
            <textarea
              id="cText"
              class="form-control form-control-sm"
              rows="3"
              placeholder="Escribe tu opinión sobre este equipo..."
              required
            ></textarea>
          </div>
          <button type="submit" class="btn btn-dark btn-sm w-100 fw-bold">
            PUBLICAR COMENTARIO
          </button>
        </form>
      </div>
    </div>
  </div>
</div>




        
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/Javascript/scripts.js"></script>

 

    <script>
      const API_BASE = "http://127.0.0.1:8000/api/users";
      const urlParams = new URLSearchParams(window.location.search);
      const productId = urlParams.get("id");

      // 1. CARGAR DATOS DEL PRODUCTO
      const loadProductDetail = async () => {
        if (!productId) {
          window.location.href = "productos.html";
          return;
        }

        try {
          const response = await fetch(`${API_BASE}/products/`);
          const products = await response.json();
          const p = products.find((item) => item.id == productId);

          if (p) {
            document.getElementById("pName").textContent = p.name;
            document.getElementById("breadcrumbProduct").textContent = p.name;
            document.getElementById("pRam").textContent = `${p.ram} GB RAM`;
            document.getElementById("pStorage").textContent = `${p.storage} GB`;
            document.getElementById("pBattery").textContent =
              `${p.max_battery} mAh`;
            document.getElementById("pSynopsis").textContent = p.synopsis;
            document.getElementById("pCam").textContent =
              `${p.main_camera_res} MP`;
            document.getElementById("pNfc").textContent = p.has_nfc
              ? "SÍ"
              : "NO";
            document.getElementById("pDate").textContent = p.release_date;
            // Si tienes imágenes en el backend:
            // document.getElementById('pImg').src = `http://127.0.0.1:8000/media/${p.product_image}`;
          }
        } catch (error) {
          console.error("Error cargando detalle:", error);
        }
      };

      // 2. CARGAR COMENTARIOS DESDE LA API
      const loadComments = async () => {
        try {
          const response = await fetch(`${API_BASE}/comments/`);
          const allComments = await response.json();

          // Filtramos solo los comentarios de ESTE producto
          const filtered = allComments.filter((c) => c.product == productId);

          const listContainer = document.getElementById("commentsList");
          listContainer.innerHTML =
            filtered
              .map(
                (c) => `
          <div class="card mb-2 border-0 shadow-sm bg-light">
            <div class="card-body p-2">
              <div class="d-flex justify-content-between align-items-center mb-1">
                <span class="badge bg-dark">${c.user}</span>
                <small class="text-muted" style="font-size:0.7rem">${c.date}</small>
              </div>
              <p class="mb-0 small text-dark">${c.comment}</p>
            </div>
          </div>
        `,
              )
              .reverse()
              .join("") ||
            '<p class="text-center text-muted small py-4">No hay comentarios. ¡Sé el primero!</p>';
        } catch (error) {
          console.error("Error cargando comentarios:", error);
        }
      };

      // 3. ENVIAR COMENTARIO (POST)
      document
        .getElementById("commentForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const payload = {
            user: document.getElementById("cUser").value.trim(),
            email: "usuario_anonimo@inventario.com", // Valor por defecto requerido por el JSON
            comment: document.getElementById("cText").value.trim(),
            product: parseInt(productId),
            date: new Date().toISOString().split("T")[0], // Fecha hoy YYYY-MM-DD
          };

          try {
            const response = await fetch(`${API_BASE}/comments/`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });

            if (response.ok) {
              e.target.reset(); // Limpiar formulario
              loadComments(); // Refrescar lista sin recargar página
            }
          } catch (error) {
            alert("Error al publicar el comentario.");
          }
        });

      // Iniciar página
      loadProductDetail();
      loadComments();
    </script>
  </body>
</html>
